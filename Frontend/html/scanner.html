<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance Scanner - QR & Face Recognition</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- Face Recognition Library -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Scanner Specific Styles */
        .scanner-header-bg {
            background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-800) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .scanner-header-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="scanner-pattern" width="20" height="20" patternUnits="userSpaceOnUse"><rect width="10" height="10" fill="rgba(255,255,255,0.05)"/><rect x="10" y="10" width="10" height="10" fill="rgba(255,255,255,0.02)"/></pattern></defs><rect width="100" height="100" fill="url(%23scanner-pattern)"/></svg>');
            opacity: 0.6;
        }

        .scanner-welcome {
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .scanner-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .scanner-subtitle {
            font-size: 1.125rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .scanner-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 1rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            display: block;
        }

        .stat-label {
            font-size: 0.875rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Scanner Interface */
        .scanner-interface {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .scanner-main {
            background: var(--surface-50);
            border-radius: var(--radius-2xl);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--surface-200);
        }

        .scanner-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Mode Selector */
        .mode-selector {
            background: var(--surface-50);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--surface-200);
        }

        .mode-selector-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .mode-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        .mode-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid var(--surface-300);
            background: var(--surface-50);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            color: var(--text-secondary);
        }

        .mode-btn:hover {
            border-color: var(--primary-300);
            background: var(--primary-50);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .mode-btn.active {
            border-color: var(--primary-500);
            background: var(--primary-50);
            color: var(--primary-700);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .mode-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .mode-btn.active .mode-icon {
            background: var(--primary-500);
            color: white;
        }

        .mode-content {
            flex: 1;
        }

        .mode-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .mode-description {
            font-size: 0.875rem;
            opacity: 0.7;
        }

        /* Scanner Display */
        .scanner-display {
            position: relative;
            margin-bottom: 2rem;
        }

        .scanner-viewport {
            background: #000;
            border-radius: var(--radius-xl);
            overflow: hidden;
            position: relative;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--surface-300);
        }

        .scanner-placeholder {
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
        }

        .scanner-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .scanner-placeholder-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .scanner-placeholder-text {
            font-size: 1rem;
            opacity: 0.7;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .scanner-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .scanner-success {
            text-align: center;
            color: white;
        }

        .scanner-success-icon {
            font-size: 3rem;
            color: var(--success-500);
            margin-bottom: 1rem;
        }

        .scanner-success-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .scanner-success-text {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Scanner Controls */
        .scanner-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .control-btn {
            padding: 1rem 2rem;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
            color: white;
            box-shadow: var(--shadow-md);
        }

        .control-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .control-btn-secondary {
            background: var(--surface-200);
            color: var(--text-secondary);
            border: 2px solid var(--surface-300);
        }

        .control-btn-secondary:hover {
            background: var(--surface-300);
        }

        .control-btn-success {
            background: var(--success-500);
            color: white;
            border: 2px solid var(--success-600);
        }

        .control-btn-success:hover:not(:disabled) {
            background: var(--success-600);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.3);
        }

        .control-btn-warning {
            background: var(--warning-500);
            color: white;
            border: 2px solid var(--warning-600);
        }

        .control-btn-warning:hover:not(:disabled) {
            background: var(--warning-600);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Status Display */
        .scanner-status {
            background: var(--surface-50);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 2rem;
            border: 1px solid var(--surface-200);
        }

        .status-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-700);
        }

        .status-scanning {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-700);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-700);
        }

        /* Recent Scans */
        .recent-scans {
            background: var(--surface-50);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--surface-200);
        }

        .recent-scans-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .recent-scans-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .scan-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .scan-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--surface-100);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
        }

        .scan-item:hover {
            background: var(--surface-200);
            transform: translateX(4px);
        }

        .scan-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .scan-icon-qr {
            background: linear-gradient(135deg, var(--primary-100), var(--primary-200));
            color: var(--primary-600);
        }

        .scan-icon-face {
            background: linear-gradient(135deg, var(--success-100), var(--success-200));
            color: var(--success-600);
        }

        .scan-icon-manual {
            background: linear-gradient(135deg, var(--warning-100), var(--warning-200));
            color: var(--warning-600);
        }

        .scan-content {
            flex: 1;
        }

        .scan-info {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .scan-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .scan-actions {
            display: flex;
            gap: 0.5rem;
        }

        .scan-action-btn {
            padding: 0.375rem;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
        }

        .scan-action-btn:hover {
            background: var(--surface-300);
            color: var(--text-primary);
        }

        /* Manual Entry */
        .manual-entry-section {
            background: var(--surface-50);
            border-radius: var(--radius-xl);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--surface-200);
        }

        .manual-entry-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }



        .training-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .training-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .training-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--surface-300);
        }

        .training-step.completed::after {
            background: var(--success-500);
        }

        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-size: 0.875rem;
            background: var(--surface-300);
            color: var(--text-secondary);
        }

        .training-step.completed .step-icon {
            background: var(--success-500);
            color: white;
        }

        .training-step.active .step-icon {
            background: var(--primary-500);
            color: white;
        }

        .step-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .training-step.active .step-label {
            color: var(--primary-600);
            font-weight: 600;
        }

        .training-step.completed .step-label {
            color: var(--success-600);
        }

        /* Enhanced Face Training Modal Styles */
        .face-training-modal {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .face-training-modal .modal-content {
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .face-training-modal .modal-body {
            flex: 1;
            overflow-y: auto;
            max-height: calc(90vh - 120px);
            padding-right: 1rem;
        }

        .face-training-modal .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .face-training-modal .modal-body::-webkit-scrollbar-track {
            background: var(--surface-100);
            border-radius: 3px;
        }

        .face-training-modal .modal-body::-webkit-scrollbar-thumb {
            background: var(--surface-300);
            border-radius: 3px;
        }

        .face-training-modal .modal-body::-webkit-scrollbar-thumb:hover {
            background: var(--surface-400);
        }

        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 1rem;
        }

        .wizard-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--surface-300);
        }

        .wizard-step.completed::after {
            background: var(--success-500);
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            background: var(--surface-300);
            color: var(--text-secondary);
            font-weight: 600;
            transition: all var(--transition-fast);
        }

        .wizard-step.completed .step-number {
            background: var(--success-500);
            color: white;
        }

        .wizard-step.active .step-number {
            background: var(--primary-500);
            color: white;
        }

        .step-info {
            font-size: 0.875rem;
        }

        .step-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .step-desc {
            color: var(--text-secondary);
        }

        .wizard-step.active .step-title {
            color: var(--primary-600);
        }

        .wizard-step.completed .step-title {
            color: var(--success-600);
        }

        .wizard-content {
            display: none;
            min-height: 400px;
        }

        .wizard-content.active {
            display: block;
        }

        .wizard-content .employee-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .wizard-content .capture-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .wizard-content .review-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .step-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .step-header h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .employee-selection {
            margin-bottom: 2rem;
        }

        .search-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .employee-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--surface-200);
            border-radius: var(--radius-lg);
        }

        .employee-card-compact {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--surface-200);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .employee-card-compact:hover {
            background: var(--surface-50);
        }

        .employee-card-compact.selected {
            background: var(--primary-50);
            border: 2px solid var(--primary-500);
        }

        .step-actions {
            margin-top: 2rem;
            text-align: center;
            padding-top: 1rem;
            border-top: 1px solid var(--surface-200);
            position: sticky;
            bottom: 0;
            background: var(--surface-50);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            margin: 2rem -1.5rem -1.5rem -1.5rem;
            padding: 1rem 1.5rem;
        }

        .employee-list::-webkit-scrollbar {
            width: 6px;
        }

        .employee-list::-webkit-scrollbar-track {
            background: var(--surface-100);
            border-radius: 3px;
        }

        .employee-list::-webkit-scrollbar-thumb {
            background: var(--surface-300);
            border-radius: 3px;
        }

        .employee-list::-webkit-scrollbar-thumb:hover {
            background: var(--surface-400);
        }

        .employee-card-compact:last-child {
            border-bottom: none;
        }

        .employee-avatar-compact {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--primary-600);
            margin-right: 1rem;
        }

        .employee-details-compact {
            flex: 1;
        }

        .employee-name-compact {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .employee-id-compact {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .employee-dept-compact {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .employee-select-btn {
            color: var(--text-secondary);
            transition: color var(--transition-fast);
        }

        .employee-card-compact:hover .employee-select-btn {
            color: var(--primary-600);
        }

        .selected-employee {
            margin-top: 1.5rem;
            padding: 1rem;
            background: var(--primary-50);
            border: 2px solid var(--primary-200);
            border-radius: var(--radius-lg);
        }

        .employee-card-compact.selected {
            background: var(--primary-50);
            border: 2px solid var(--primary-500);
        }

        .selection-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--success-600);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .camera-setup {
            display: flex;
            gap: 2rem;
        }

        .camera-preview-container {
            flex: 1;
        }

        .camera-viewport {
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--surface-300);
            overflow: hidden;
            position: relative;
        }

        .camera-viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-md);
        }

        .camera-placeholder {
            color: var(--text-secondary);
            text-align: center;
        }

        .camera-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .camera-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .camera-info {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background: var(--success-500);
        }

        .status-warning {
            background: var(--warning-500);
        }

        .status-error {
            background: var(--danger-500);
        }

        .camera-tips {
            margin-top: 1.5rem;
        }

        .camera-tips h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .tips-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .tips-list li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .tips-list li::before {
            content: '💡';
            position: absolute;
            left: 0;
            top: 0.5rem;
        }

        .capture-section {
            display: flex;
            gap: 2rem;
        }

        .capture-main {
            flex: 1;
        }

        .capture-camera {
            position: relative;
            margin-bottom: 2rem;
        }

        .camera-viewport-large {
            width: 100%;
            height: 350px;
            background: #000;
            border-radius: var(--radius-xl);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--surface-300);
            overflow: hidden;
            position: relative;
        }

        .camera-viewport-large video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }

        .capture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .face-guide {
            position: relative;
        }

        .face-outline {
            width: 200px;
            height: 250px;
            border: 3px solid var(--primary-500);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
        }

        .face-outline::before {
            content: '';
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 20px;
            border: 2px solid var(--primary-500);
            border-bottom: none;
            border-radius: 50% 50% 0 0;
        }

        .face-instruction {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary-500);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .capture-controls {
            margin-bottom: 2rem;
        }

        .capture-progress {
            margin-bottom: 1.5rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-text {
            font-weight: 600;
            color: var(--text-primary);
        }

        .progress-percentage {
            color: var(--primary-600);
            font-weight: 700;
        }

        .progress-bar-modern {
            width: 100%;
            height: 8px;
            background: var(--surface-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-modern {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
            border-radius: 4px;
            transition: width var(--transition-normal);
        }

        .capture-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.125rem;
        }

        .capture-instructions {
            margin-top: 2rem;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
            opacity: 0.6;
        }

        .instruction-item.active {
            background: var(--primary-50);
            border: 2px solid var(--primary-200);
            opacity: 1;
        }

        .instruction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-200);
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .instruction-item.active .instruction-icon {
            background: var(--primary-500);
            color: white;
        }

        .instruction-text {
            flex: 1;
        }

        .instruction-text strong {
            color: var(--text-primary);
        }

        .captured-thumbnails {
            margin-top: 2rem;
        }

        .captured-thumbnails h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .thumbnails-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 1rem;
        }

        .image-thumbnail {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 2px solid var(--surface-200);
        }

        .image-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-step {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: var(--primary-500);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .review-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .review-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .summary-card {
            background: var(--surface-50);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--surface-200);
        }

        .summary-icon {
            width: 48px;
            height: 48px;
            background: var(--primary-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: var(--primary-600);
        }

        .summary-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .summary-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .summary-value {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .review-gallery h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .review-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .review-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 2px solid var(--surface-200);
        }

        .review-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .review-image-step {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: var(--primary-500);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .training-options h5 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border: 2px solid var(--surface-200);
            border-radius: var(--radius-lg);
            background: var(--surface-50);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .option-item:hover {
            border-color: var(--primary-300);
            background: var(--primary-50);
        }

        .checkbox-input {
            width: 1.125rem;
            height: 1.125rem;
            accent-color: var(--primary-500);
            margin-top: 0.125rem;
            flex-shrink: 0;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .option-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .completion-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Modal Header Enhancements */
        .modal-title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .modal-icon {
            font-size: 1.5rem;
            color: var(--primary-600);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .modal-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .training-progress {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            width: 100px;
            height: 6px;
            background: var(--surface-200);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
            border-radius: 3px;
            transition: width var(--transition-normal);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .scanner-interface {
                grid-template-columns: 1fr;
            }

            .scanner-sidebar {
                order: -1;
            }

            .face-training-modal {
                max-width: 95%;
                margin: 1rem;
            }

            .camera-setup {
                flex-direction: column;
                gap: 1.5rem;
            }

            .capture-section {
                flex-direction: column;
                gap: 1.5rem;
            }

            .review-summary {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .scanner-title {
                font-size: 2rem;
            }

            .scanner-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .scanner-interface {
                gap: 1rem;
            }

            .mode-buttons {
                grid-template-columns: 1fr;
            }

            .manual-entry-form {
                grid-template-columns: 1fr;
            }

            .scanner-viewport {
                min-height: 300px;
            }

            .wizard-steps {
                flex-direction: column;
                gap: 1rem;
            }

            .wizard-step:not(:last-child)::after {
                display: none;
            }

            .search-section {
                flex-direction: column;
            }

            .camera-viewport {
                height: 200px;
            }

            .camera-viewport-large {
                height: 280px;
            }

            .face-outline {
                width: 150px;
                height: 200px;
            }

            .thumbnails-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }

            .review-images-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .scanner-header-bg {
                padding: 1.5rem 0;
            }

            .scanner-title {
                font-size: 1.75rem;
            }

            .scanner-controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 250px;
            }

            .capture-actions {
                flex-direction: column;
            }

            .capture-actions .btn {
                width: 100%;
            }

            .completion-actions {
                flex-direction: column;
            }

            .completion-actions .btn {
                width: 100%;
            }
        }

        /* Animations */
        @keyframes scanPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        .scanning .scanner-viewport {
            animation: scanPulse 2s infinite;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .scanner-main,
            .mode-selector,
            .recent-scans,
            .manual-entry-section {
                background: rgba(17, 24, 39, 0.8);
                border-color: rgba(55, 65, 81, 0.3);
            }

            .scan-item {
                background: rgba(31, 41, 55, 0.8);
            }

            .scan-item:hover {
                background: rgba(55, 65, 81, 0.8);
            }
        }
    </style>
</head>
<body class="page-container">
    <!-- Modern Navigation -->
    <nav class="navbar">
        <div class="container">
            <a href="dashboard.html" class="nav-brand profile-brand">
                <div class="brand-logo-wrap"><img src="/images/images.png" alt="ECC" class="brand-logo-img"></div>
                <div class="brand-text">
                    <h1 style="margin:0;color:#fff;font-size:1.5rem;">ECC Smart Attendance</h1>
                    <span class="brand-subtitle" data-i18n="scannerInterface" style="color:rgba(255,255,255,.85)">Scanner Interface</span>
                </div>
            </a>
            <div class="nav-menu" style="align-items:center; gap:.75rem;">
                <button id="langToggleNav" class="btn btn-outline btn-sm" style="margin-right:.25rem;">አማርኛ / EN</button>
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    <span data-i18n="dashboard">Dashboard</span>
                </a>
                <a href="employees.html" class="nav-link">
                    <i class="fas fa-users"></i>
                    <span data-i18n="employees">Employees</span>
                </a>
                <a href="scanner.html" class="nav-link active">
                    <i class="fas fa-qrcode"></i>
                    <span data-i18n="scanner">Scanner</span>
                </a>
                <a href="reports.html" class="nav-link">
                    <i class="fas fa-chart-bar"></i>
                    <span data-i18n="reports">Reports</span>
                </a>
                <a href="#" class="nav-link" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="logout">Logout</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Scanner Header -->
    <header class="scanner-header-bg">
        <div class="container">
            <div class="scanner-welcome">
                <h1 class="scanner-title">Smart Attendance Scanner</h1>
                <p class="scanner-subtitle">Advanced QR code and facial recognition technology for seamless attendance tracking</p>

                <div class="scanner-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="todayScans">0</span>
                        <span class="stat-label">Today's Scans</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="activeUsers">0</span>
                        <span class="stat-label">Active Users</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="successRate">0%</span>
                        <span class="stat-label">Success Rate</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="avgTime">0s</span>
                        <span class="stat-label">Avg. Scan Time</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="trainedFacesCount">0</span>
                        <span class="stat-label">Trained Faces</span>
                    </div>
                    <div class="stat-item">
                        <div class="face-models-status" id="faceModelsStatus">
                            <i class="fas fa-spinner fa-spin" style="color: var(--warning-500); font-size: 0.9rem;"></i>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">Loading AI Models</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Scanner Interface -->
    <main class="container">
        <div class="scanner-interface">
            <!-- Main Scanner Area -->
            <div class="scanner-main">
                <!-- Mode Selector -->
                <div class="mode-selector">
                    <h3 class="mode-selector-title">Select Scanning Mode</h3>
                    <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="qr" onclick="switchMode('qr')">
                            <div class="mode-icon">
                                <i class="fas fa-qrcode"></i>
                            </div>
                            <div class="mode-content">
                                <div class="mode-title">QR Code Scanner</div>
                                <div class="mode-description">Fast digital scanning with offline capability</div>
                            </div>
                        </button>

                        <button class="mode-btn" data-mode="face" onclick="switchMode('face')">
                            <div class="mode-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="mode-content">
                                <div class="mode-title">Face Recognition</div>
                                <div class="mode-description">AI-powered facial recognition technology</div>
                            </div>
                        </button>

                        <button class="mode-btn" data-mode="manual" onclick="switchMode('manual')">
                            <div class="mode-icon">
                                <i class="fas fa-keyboard"></i>
                            </div>
                            <div class="mode-content">
                                <div class="mode-title">Manual Entry</div>
                                <div class="mode-description">Manual attendance entry with validation</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- QR Scanner Section -->
                <div id="qrSection" class="scanner-section">
                    <div class="scanner-display">
                        <div class="scanner-viewport" id="qrScannerContainer">
                            <div class="scanner-placeholder">
                                <div class="scanner-placeholder-icon">
                                    <i class="fas fa-qrcode"></i>
                                </div>
                                <h3 class="scanner-placeholder-title">QR Code Scanner Ready</h3>
                                <p class="scanner-placeholder-text">Click "Start Scanning" to begin attendance tracking</p>
                            </div>
                        </div>

                        <div class="scanner-overlay" id="qrSuccessOverlay">
                            <div class="scanner-success">
                                <div class="scanner-success-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h4 class="scanner-success-title">Scan Successful!</h4>
                                <p class="scanner-success-text">Attendance recorded successfully</p>
                            </div>
                        </div>
                    </div>

                    <div class="scanner-status">
                        <div class="status-header">
                            <span class="status-title">Scanner Status</span>
                            <div class="status-indicator status-ready" id="qrStatus">
                                <i class="fas fa-circle"></i>
                                <span>Ready</span>
                            </div>
                        </div>
                    </div>

                    <div class="scanner-controls">
                        <button class="control-btn control-btn-primary" id="startQrBtn" onclick="startQrScanner()">
                            <i class="fas fa-play"></i>
                            Start Scanning
                        </button>
                        <button class="control-btn control-btn-secondary" id="stopQrBtn" onclick="stopQrScanner()" disabled>
                            <i class="fas fa-stop"></i>
                            Stop Scanning
                        </button>
                    </div>
                </div>

                <!-- Face Scanner Section -->
                <div id="faceSection" class="scanner-section" style="display: none;">
                    <div class="scanner-display">
                        <div class="scanner-viewport" id="faceScannerContainer">
                            <div class="scanner-placeholder">
                                <div class="scanner-placeholder-icon">
                                    <i class="fas fa-user"></i>
                                </div>
                                <h3 class="scanner-placeholder-title">Face Recognition Ready</h3>
                                <p class="scanner-placeholder-text">Click "Start Face Scanner" to begin facial recognition</p>
                            </div>
                        </div>

                        <div class="scanner-overlay" id="faceSuccessOverlay">
                            <div class="scanner-success">
                                <div class="scanner-success-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h4 class="scanner-success-title">Face Recognized!</h4>
                                <p class="scanner-success-text">Attendance recorded for recognized employee</p>
                            </div>
                        </div>
                    </div>

                    <div class="scanner-status">
                        <div class="status-header">
                            <span class="status-title">Face Scanner Status</span>
                            <div class="status-indicator status-ready" id="faceStatus">
                                <i class="fas fa-circle"></i>
                                <span>Ready</span>
                            </div>
                        </div>
                    </div>

                    <div class="scanner-controls">
                        <button class="control-btn control-btn-primary" id="startFaceBtn" onclick="startFaceScanner()">
                            <i class="fas fa-play"></i>
                            Start Face Scanner
                        </button>
                        <button class="control-btn control-btn-secondary" id="stopFaceBtn" onclick="stopFaceScanner()" disabled>
                            <i class="fas fa-stop"></i>
                            Stop Scanner
                        </button>
                        <button class="control-btn control-btn-success" id="startRecognitionBtn" onclick="startFaceRecognition()" disabled style="display: none;">
                            <i class="fas fa-user-check"></i>
                            Start Recognition
                        </button>
                        <button class="control-btn control-btn-warning" id="stopRecognitionBtn" onclick="stopFaceRecognition()" disabled style="display: none;">
                            <i class="fas fa-user-times"></i>
                            Stop Recognition
                        </button>
                        <button class="control-btn control-btn-secondary" onclick="showFaceTrainingModal()">
                            <i class="fas fa-graduation-cap"></i>
                            Train New Face
                        </button>
                    </div>
                </div>

                <!-- Manual Entry Section -->
                <div id="manualSection" class="manual-entry-section" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 2rem; color: var(--text-primary);">
                        <i class="fas fa-keyboard"></i> Manual Attendance Entry
                    </h3>

                    <form id="manualEntryForm" class="manual-entry-form">
                        <div class="form-group">
                            <label class="form-label">Employee ID</label>
                            <input type="text" id="manualEmployeeId" class="form-control" placeholder="Enter employee ID" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Attendance Type</label>
                            <select id="manualAttendanceType" class="form-control" required>
                                <option value="">Select type</option>
                                <option value="checkin">Check In</option>
                                <option value="checkout">Check Out</option>
                            </select>
                        </div>

                        <div class="form-group form-group-full">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea id="manualNotes" class="form-control" rows="3" placeholder="Additional notes or comments"></textarea>
                        </div>

                        <div class="form-group form-group-full" style="text-align: center;">
                            <button type="submit" class="control-btn control-btn-primary">
                                <i class="fas fa-save"></i>
                                Submit Attendance
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="scanner-sidebar">
                <!-- Recent Scans -->
                <div class="recent-scans">
                    <div class="recent-scans-header">
                        <h3 class="recent-scans-title">Recent Scans</h3>
                        <button class="btn btn-ghost btn-sm" onclick="clearScanHistory()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="scan-list" id="scanList">
                        <div class="empty-state" style="padding: 2rem 1rem; text-align: center;">
                            <i class="fas fa-inbox" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                            <p style="color: var(--text-secondary); font-size: 0.875rem;">No scans yet</p>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="mode-selector">
                    <h4 style="text-align: center; margin-bottom: 1rem; color: var(--text-primary);">Quick Actions</h4>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <button class="btn btn-secondary btn-sm" onclick="exportScanHistory()">
                            <i class="fas fa-download"></i>
                            Export History
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="refreshScanner()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh Scanner
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="showSystemInfo()">
                            <i class="fas fa-info-circle"></i>
                            System Info
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Face Training Modal -->
    <div id="faceTrainingModal" class="modal">
        <div class="modal-dialog face-training-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title-section">
                        <i class="fas fa-graduation-cap modal-icon"></i>
                        <div>
                            <h3 class="modal-title">Advanced Face Training</h3>
                            <p class="modal-subtitle">Train the system to recognize employee faces</p>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <div class="training-progress">
                            <span id="currentStepText">Step 1 of 4</span>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 25%;"></div>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeFaceTrainingModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <!-- Enhanced Training Steps -->
                    <div class="training-wizard">
                        <div class="wizard-steps">
                            <div class="wizard-step active" data-step="1">
                                <div class="step-number">1</div>
                                <div class="step-info">
                                    <div class="step-title">Select Employee</div>
                                    <div class="step-desc">Choose employee</div>
                                </div>
                                <div class="step-status">
                                    <i class="fas fa-check-circle step-check"></i>
                                </div>
                            </div>
                            <div class="wizard-step" data-step="2">
                                <div class="step-number">2</div>
                                <div class="step-info">
                                    <div class="step-title">Setup Camera</div>
                                    <div class="step-desc">Initialize camera</div>
                                </div>
                                <div class="step-status">
                                    <i class="fas fa-check-circle step-check"></i>
                                </div>
                            </div>
                            <div class="wizard-step" data-step="3">
                                <div class="step-number">3</div>
                                <div class="step-info">
                                    <div class="step-title">Capture Photos</div>
                                    <div class="step-desc">Take 4 photos</div>
                                </div>
                                <div class="step-status">
                                    <i class="fas fa-check-circle step-check"></i>
                                </div>
                            </div>
                            <div class="wizard-step" data-step="4">
                                <div class="step-number">4</div>
                                <div class="step-info">
                                    <div class="step-title">Complete</div>
                                    <div class="step-desc">Save training</div>
                                </div>
                                <div class="step-status">
                                    <i class="fas fa-check-circle step-check"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Step 1: Employee Selection -->
                        <div class="wizard-content active" id="wizardStep1">
                            <div class="step-header">
                                <h4><i class="fas fa-user"></i> Select Employee</h4>
                                <p>Choose the employee to train</p>
                            </div>

                            <div class="employee-selection">
                                <div class="search-section">
                                    <div class="search-input-group">
                                        <i class="fas fa-search search-icon"></i>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="employeeSearchInput"
                                            placeholder="Search employees by name or ID..."
                                        >
                                    </div>
                                    <button class="btn btn-outline" onclick="loadEmployeesForTraining()">
                                        <i class="fas fa-sync-alt"></i>
                                        Refresh List
                                    </button>
                                </div>

                                <div class="employee-list" id="employeeList">
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <p>Click "Refresh List" to load employees</p>
                                    </div>
                                </div>

                                <div class="selected-employee" id="selectedEmployeeInfo" style="display: none;">
                                    <div class="employee-card-compact">
                                        <div class="employee-avatar-compact">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="employee-details-compact">
                                            <div class="employee-name-compact" id="selectedEmployeeName"></div>
                                            <div class="employee-id-compact" id="selectedEmployeeId"></div>
                                        </div>
                                        <div class="selection-indicator">
                                            <i class="fas fa-check-circle"></i>
                                            Selected
                                        </div>
                                    </div>
                                </div>

                                <div class="step-actions">
                                    <button class="btn btn-primary btn-large" onclick="proceedToCameraSetup()" id="continueToCameraBtn" disabled>
                                        <i class="fas fa-arrow-right"></i>
                                        Continue to Camera Setup
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Camera Setup -->
                        <div class="wizard-content" id="wizardStep2">
                            <div class="step-header">
                                <h4><i class="fas fa-camera"></i> Camera Setup</h4>
                                <p>Initialize camera for face capture</p>
                            </div>

                            <div class="camera-setup">
                                <div class="camera-preview-container">
                                    <div class="camera-viewport" id="setupCameraContainer">
                                        <div class="camera-placeholder">
                                            <i class="fas fa-video"></i>
                                            <p>Camera preview will appear here</p>
                                        </div>
                                    </div>

                                    <div class="camera-controls">
                                        <div class="camera-info">
                                            <div class="info-item">
                                                <i class="fas fa-circle status-indicator" id="cameraStatus"></i>
                                                <span id="cameraStatusText">Initializing camera...</span>
                                            </div>
                                            <div class="info-item">
                                                <i class="fas fa-lightbulb"></i>
                                                <span>Ensure good lighting</span>
                                            </div>
                                            <div class="info-item">
                                                <i class="fas fa-expand"></i>
                                                <span>Face should fill the frame</span>
                                            </div>
                                        </div>

                                        <div class="camera-actions">
                                            <button class="btn btn-primary" id="proceedToCaptureBtn" onclick="proceedToCapture()" disabled>
                                                <i class="fas fa-arrow-right"></i>
                                                Start Capturing Images
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="camera-tips">
                                    <h5><i class="fas fa-info-circle"></i> Camera Tips</h5>
                                    <ul class="tips-list">
                                        <li>Ensure your face is well-lit and clearly visible</li>
                                        <li>Remove glasses if they interfere with recognition</li>
                                        <li>Look directly at the camera with a neutral expression</li>
                                        <li>Keep your head steady during capture</li>
                                        <li>Avoid bright backgrounds or direct light sources</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: Image Capture -->
                        <div class="wizard-content" id="wizardStep3">
                            <div class="step-header">
                                <h4><i class="fas fa-camera-retro"></i> Capture Photos</h4>
                                <p>Take 4 photos for face recognition training</p>
                            </div>

                            <div class="capture-section">
                                <div class="capture-main">
                                    <div class="capture-camera">
                                        <div class="camera-viewport-large" id="captureCameraContainer">
                                            <div class="camera-placeholder">
                                                <i class="fas fa-camera"></i>
                                                <p>Camera will appear here</p>
                                            </div>
                                        </div>

                                        <div class="capture-overlay" id="captureOverlay">
                                            <div class="face-guide">
                                                <div class="face-outline"></div>
                                                <div class="face-instruction">Position your face in the circle</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="capture-controls">
                                        <div class="capture-progress">
                                            <div class="progress-header">
                                                <span class="progress-text">
                                                    <span id="capturedCount">0</span> / <span id="requiredCount">4</span> images captured
                                                </span>
                                                <span class="progress-percentage" id="progressPercentage">0%</span>
                                            </div>
                                            <div class="progress-bar-modern">
                                                <div class="progress-fill-modern" id="captureProgressFill"></div>
                                            </div>
                                        </div>

                                        <div class="capture-actions">
                                            <button class="btn btn-secondary" id="retakeLastBtn" onclick="retakeLastImage()" disabled>
                                                <i class="fas fa-undo"></i>
                                                Retake Last
                                            </button>
                                            <button class="btn btn-primary btn-large" id="captureImageBtn" onclick="captureTrainingImage()">
                                                <i class="fas fa-camera"></i>
                                                <span id="captureButtonText">Capture Image</span>
                                            </button>
                                        </div>

                                        <div class="capture-instructions">
                                            <div class="instruction-item active" data-step="1">
                                                <div class="instruction-icon">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <div class="instruction-text">
                                                    <strong>Front View:</strong> Look directly at the camera
                                                </div>
                                            </div>
                                            <div class="instruction-item" data-step="2">
                                                <div class="instruction-icon">
                                                    <i class="fas fa-smile"></i>
                                                </div>
                                                <div class="instruction-text">
                                                    <strong>With Smile:</strong> Smile naturally
                                                </div>
                                            </div>
                                            <div class="instruction-item" data-step="3">
                                                <div class="instruction-icon">
                                                    <i class="fas fa-meh"></i>
                                                </div>
                                                <div class="instruction-text">
                                                    <strong>Neutral:</strong> Return to neutral expression
                                                </div>
                                            </div>
                                            <div class="instruction-item" data-step="4">
                                                <div class="instruction-icon">
                                                    <i class="fas fa-check"></i>
                                                </div>
                                                <div class="instruction-text">
                                                    <strong>Final Check:</strong> One more photo for accuracy
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="captured-thumbnails">
                                    <h5>Captured Images</h5>
                                    <div class="thumbnails-grid" id="thumbnailsGrid">
                                        <!-- Captured image thumbnails will appear here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: Review and Complete -->
                        <div class="wizard-content" id="wizardStep4">
                            <div class="step-header">
                                <h4><i class="fas fa-check-circle"></i> Review & Complete</h4>
                                <p>Review images and save training data</p>
                            </div>

                            <div class="review-section">
                                <div class="review-summary">
                                    <div class="summary-card">
                                        <div class="summary-icon">
                                            <i class="fas fa-user-check"></i>
                                        </div>
                                        <div class="summary-content">
                                            <div class="summary-title">Employee</div>
                                            <div class="summary-value" id="reviewEmployeeName"></div>
                                        </div>
                                    </div>

                                    <div class="summary-card">
                                        <div class="summary-icon">
                                            <i class="fas fa-images"></i>
                                        </div>
                                        <div class="summary-content">
                                            <div class="summary-title">Images Captured</div>
                                            <div class="summary-value" id="reviewImageCount"></div>
                                        </div>
                                    </div>

                                    <div class="summary-card">
                                        <div class="summary-icon">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                        <div class="summary-content">
                                            <div class="summary-title">Training Time</div>
                                            <div class="summary-value" id="reviewTrainingTime"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="review-gallery">
                                    <h5>All Captured Images</h5>
                                    <div class="review-images-grid" id="reviewImagesGrid">
                                        <!-- All captured images will appear here -->
                                    </div>
                                </div>

                                <div class="training-options">
                                    <h5>Training Options</h5>
                                    <div class="options-grid">
                                        <label class="option-item">
                                            <input type="checkbox" id="enhanceQuality" checked>
                                            <span class="checkmark"></span>
                                            <div class="option-content">
                                                <div class="option-title">Enhance Image Quality</div>
                                                <div class="option-desc">Apply basic enhancement for better recognition</div>
                                            </div>
                                        </label>

                                        <label class="option-item">
                                            <input type="checkbox" id="testRecognition" checked>
                                            <span class="checkmark"></span>
                                            <div class="option-content">
                                                <div class="option-title">Test Recognition</div>
                                                <div class="option-desc">Quick test to verify face recognition works</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>

                                <div class="completion-actions">
                                    <button class="btn btn-outline" onclick="restartTraining()">
                                        <i class="fas fa-redo"></i>
                                        Start Over
                                    </button>
                                    <button class="btn btn-primary btn-large" onclick="completeTraining()">
                                        <i class="fas fa-save"></i>
                                        <span id="completeButtonText">Complete Training</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scanner.js temporarily disabled due to ID conflicts -->
    <!-- <script src="../js/scanner.js"></script> -->
    <script>
        // Enhanced scanner interface with advanced face training functionality
        let currentMode = 'qr';
        let qrScanner = null;
        let faceScanner = null;
        let scanHistory = [];
        let hasMarkedThisSession = false;

        // Face Training Variables
        let selectedEmployee = null;
        let trainingImages = [];
        let currentInstructionStep = 1;
        let trainingStartTime = null;
        let setupCameraStream = null;
        let captureCameraStream = null;
        let isCameraReady = false;

        // Face Recognition Variables
        let isFaceApiLoaded = false;
        let labeledFaceDescriptors = [];
        let recognitionInterval = null;
        let isRecognizing = false;
        let isScanning = false;
        const FACE_MATCH_THRESHOLD = 0.65; // slightly relaxed for better recall

        // Initialize scanner
        document.addEventListener('DOMContentLoaded', function() {
            loadScanHistory();
            updateStats();
            initializeFaceTraining();
            initializeFaceRecognition();
        });

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;

            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');

            // Show/hide sections
            document.getElementById('qrSection').style.display = mode === 'qr' ? 'block' : 'none';
            document.getElementById('faceSection').style.display = mode === 'face' ? 'block' : 'none';
            document.getElementById('manualSection').style.display = mode === 'manual' ? 'block' : 'none';

            // Stop any active scanning
            stopQrScanner();
            stopFaceScanner();
        }

        // QR Scanner Functions
        async function startQrScanner() {
            try {
                if (isScanning) return;

                const container = document.getElementById('qrScannerContainer');
                container.innerHTML = '';

                // Preflight checks for camera support and availability
                if (!window.isSecureContext) {
                    showNotification('QR requires secure context (https or localhost).', 'error');
                    console.error('Insecure context: getUserMedia may be blocked');
                }
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showNotification('Camera not supported on this device/browser.', 'error');
                    return;
                }

                // Verify at least one camera is available
                try {
                    const cameras = await (window.Html5Qrcode && Html5Qrcode.getCameras ? Html5Qrcode.getCameras() : Promise.resolve([]));
                    if (!cameras || cameras.length === 0) {
                        showNotification('No cameras found. Plug in or enable a camera.', 'error');
                        return;
                    }
                } catch (camErr) {
                    console.warn('Camera enumeration failed:', camErr);
                }

                if (typeof Html5QrcodeScanner === 'undefined') {
                    // Lazy load fallback if CDN failed
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js';
                    script.onload = () => startQrScanner();
                    script.onerror = () => {
                        console.error('Failed to load html5-qrcode library');
                        showNotification('QR library failed to load. Check internet connection.', 'error');
                    };
                    document.head.appendChild(script);
                    return;
                }

                qrScanner = new Html5QrcodeScanner("qrScannerContainer", {
                    fps: 10,
                    qrbox: 250,
                    aspectRatio: 1.0,
                    showTorchButtonIfSupported: true,
                    showZoomSliderIfSupported: true,
                });

                qrScanner.render(
                    async (decodedText) => {
                        await handleQrScan(decodedText);
                    },
                    (scanError) => {
                        // Suppress frequent decode errors; log only severe ones
                        if (typeof scanError === 'string' && scanError.includes('NotFoundException')) return;
                        // Uncomment for verbose logging:
                        // console.debug('QR decode error:', scanError);
                    }
                );

                isScanning = true;
                updateStatus('qr', 'scanning', 'Scanning...');

                document.getElementById('startQrBtn').disabled = true;
                document.getElementById('stopQrBtn').disabled = false;
                container.classList.add('scanning');

                showNotification('QR Scanner started successfully', 'success');
            } catch (error) {
                console.error('QR Scanner error:', error);
                // Map common errors to actionable messages
                let message = 'Failed to start QR scanner';
                const name = error && (error.name || error.code || '');
                if (name === 'NotAllowedError' || name === 'PermissionDeniedError') {
                    message = 'Camera permission denied. Please allow camera access in your browser.';
                } else if (name === 'NotFoundError' || name === 'DevicesNotFoundError') {
                    message = 'No camera found. Connect a camera and try again.';
                } else if (name === 'NotReadableError' || name === 'TrackStartError') {
                    message = 'Camera is in use by another application. Close it and retry.';
                } else if (name === 'OverconstrainedError') {
                    message = 'Requested camera constraints not supported. Try default settings.';
                } else if (name === 'NotSupportedError' || name === 'SecurityError') {
                    message = 'Camera blocked by browser. Ensure you are on https or localhost and not in an iframe.';
                }
                showNotification(message, 'error');
                isScanning = false;
                resetQrScannerUI();
            }
        }

        function stopQrScanner() {
            if (qrScanner && isScanning) {
                try { qrScanner.clear(); } catch (_) {}
                qrScanner = null;
                isScanning = false;

                updateStatus('qr', 'ready', 'Ready');
                resetQrScannerUI();
                showNotification('QR Scanner stopped', 'info');
            }
        }

        async function handleQrScan(decodedText) {
            try {
                console.log('QR Code scanned:', decodedText);

                // Add to scan history
                const scanEntry = {
                    type: 'QR Code',
                    data: decodedText,
                    timestamp: new Date().toISOString(),
                    mode: 'QR',
                    success: true
                };

                scanHistory.unshift(scanEntry);
                saveScanHistory();
                updateScanHistoryUI();

                // Show success overlay
                showScanSuccess('qr');

                // Update stats
                updateStats();

                // Stop scanner after successful scan
                setTimeout(() => {
                    stopQrScanner();
                }, 2000);

                showNotification(`QR Code scanned: ${decodedText}`, 'success');
            } catch (error) {
                console.error('QR Scan handling error:', error);
                showNotification('Failed to process QR scan', 'error');
            }
        }

        function resetQrScannerUI() {
            const container = document.getElementById('qrScannerContainer');
            container.classList.remove('scanning');
            container.innerHTML = `
                <div class="scanner-placeholder">
                    <div class="scanner-placeholder-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h3 class="scanner-placeholder-title">QR Code Scanner Ready</h3>
                    <p class="scanner-placeholder-text">Click "Start Scanning" to begin attendance tracking</p>
                </div>
            `;

            document.getElementById('startQrBtn').disabled = false;
            document.getElementById('stopQrBtn').disabled = true;
        }

        // Face Scanner Functions
        async function startFaceScanner() {
            try {
                const container = document.getElementById('faceScannerContainer');

                // Request high-quality camera access for face recognition
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280, min: 640 },
                        height: { ideal: 720, min: 480 },
                        frameRate: { ideal: 30, min: 15 }
                    }
                });

                container.innerHTML = `
                    <video id="faceVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-xl);"></video>
                `;

                const video = document.getElementById('faceVideo');
                video.srcObject = stream;

                faceScanner = stream;
                updateStatus('face', 'scanning', 'Scanning...');
                hasMarkedThisSession = false;

                document.getElementById('startFaceBtn').disabled = true;
                document.getElementById('stopFaceBtn').disabled = false;

                // Automatically start face recognition if faces are trained
                const savedFaces = localStorage.getItem('savedFaces');
                if (savedFaces && JSON.parse(savedFaces).length > 0) {
                    // Start automatic face recognition
                    setTimeout(() => {
                        startAutomaticFaceRecognition();
                    }, 1000); // Give camera time to initialize
                } else {
                    showNotification('No trained faces found. Please train faces first for automatic recognition.', 'info');
                }

                showNotification('Face scanner started - automatic recognition active!', 'success');
            } catch (error) {
                console.error('Face Scanner error:', error);
                showNotification('Failed to start face scanner: ' + error.message, 'error');
            }
        }

        function stopFaceScanner() {
            if (faceScanner) {
                faceScanner.getTracks().forEach(track => track.stop());
                faceScanner = null;

                updateStatus('face', 'ready', 'Ready');
                resetFaceScannerUI();
                showNotification('Face scanner stopped', 'info');
                hasMarkedThisSession = false;
            }
        }

        function resetFaceScannerUI() {
            const container = document.getElementById('faceScannerContainer');
            container.innerHTML = `
                <div class="scanner-placeholder">
                    <div class="scanner-placeholder-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <h3 class="scanner-placeholder-title">Face Recognition Ready</h3>
                    <p class="scanner-placeholder-text">Click "Start Face Scanner" to begin facial recognition</p>
                </div>
            `;

            document.getElementById('startFaceBtn').disabled = false;
            document.getElementById('stopFaceBtn').disabled = true;
        }

        // Manual Entry Functions
        document.getElementById('manualEntryForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const employeeId = document.getElementById('manualEmployeeId').value;
            const attendanceType = document.getElementById('manualAttendanceType').value;
            const notes = document.getElementById('manualNotes').value;

            if (!employeeId || !attendanceType) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Add to scan history
            const scanEntry = {
                type: 'Manual Entry',
                data: `Employee: ${employeeId}, Type: ${attendanceType}`,
                timestamp: new Date().toISOString(),
                mode: 'Manual',
                notes: notes,
                success: true
            };

            scanHistory.unshift(scanEntry);
            saveScanHistory();
            updateScanHistoryUI();
            updateStats();

            // Reset form
            this.reset();

            showNotification(`Manual entry recorded for Employee ${employeeId}`, 'success');
        });

        // Face Training Modal Functions
        function resetTrainingWizard() {
            selectedEmployee = null;
            trainingImages = [];
            currentInstructionStep = 1;
            trainingStartTime = null;
            isCameraReady = false;

            document.getElementById('selectedEmployeeInfo').style.display = 'none';
            document.getElementById('continueToCameraBtn').disabled = true;
            document.getElementById('employeeList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <p>Click "Refresh List" to load employees</p>
                </div>
            `;
            document.getElementById('thumbnailsGrid').innerHTML = '';
            document.getElementById('reviewImagesGrid').innerHTML = '';
        }

        function showFaceTrainingModal() {
            document.getElementById('faceTrainingModal').classList.add('show');
            resetTrainingWizard();
            initializeFaceTraining();
            goToWizardStep(1);
            updateInstructionStep(1); // Initialize first instruction
        }

        function closeFaceTrainingModal() {
            document.getElementById('faceTrainingModal').classList.remove('show');

            // Clean up any active camera streams
            if (setupCameraStream) {
                setupCameraStream.getTracks().forEach(track => track.stop());
                setupCameraStream = null;
            }
            if (captureCameraStream) {
                captureCameraStream.getTracks().forEach(track => track.stop());
                captureCameraStream = null;
            }

            // Reset camera ready state
            isCameraReady = false;

            resetTrainingWizard();
        }

        async function loadEmployeesForTraining() {
            try {
                showNotification('Loading employees...', 'info');

                // Try backend first (auth required)
                let employees = [];
                try {
                    const res = await fetch('/employee/list');
                    if (res.ok) {
                        const data = await res.json();
                        employees = (data.employees || []).map(e => ({
                            id: e.employee_id,
                            name: e.name,
                            department: e.department || '—',
                            position: e.position || '—'
                        }));
                    }
                } catch (_) {}

                // Fallback to demo data if backend not available or empty
                if (!employees || employees.length === 0) {
                    employees = [
                        { id: 'EMP001', name: 'John Doe', department: 'Engineering', position: 'Senior Developer' },
                        { id: 'EMP002', name: 'Jane Smith', department: 'Marketing', position: 'Marketing Manager' },
                        { id: 'EMP003', name: 'Bob Johnson', department: 'Sales', position: 'Sales Representative' },
                        { id: 'EMP004', name: 'Alice Brown', department: 'Engineering', position: 'Software Engineer' },
                        { id: 'EMP005', name: 'Charlie Wilson', department: 'Finance', position: 'Financial Analyst' },
                        { id: 'EMP006', name: 'Diana Ross', department: 'HR', position: 'HR Manager' },
                        { id: 'EMP007', name: 'Edward Norton', department: 'Operations', position: 'Operations Manager' },
                        { id: 'EMP008', name: 'Fiona Green', department: 'Design', position: 'UX Designer' }
                    ];
                }

                renderEmployeeList(employees);
                showNotification(`Loaded ${employees.length} employees successfully`, 'success');
            } catch (error) {
                console.error('Error loading employees:', error);
                showNotification('Failed to load employees', 'error');
            }
        }

        function renderEmployeeList(employees) {
            const container = document.getElementById('employeeList');

            container.innerHTML = employees.map(employee => `
                <div class="employee-card-compact" onclick="selectEmployee('${employee.id}', '${employee.name}', '${employee.department}', '${employee.position}')">
                    <div class="employee-avatar-compact">
                        ${employee.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div class="employee-details-compact">
                        <div class="employee-name-compact">${employee.name}</div>
                        <div class="employee-id-compact">${employee.id}</div>
                        <div class="employee-dept-compact">${employee.department} • ${employee.position}</div>
                    </div>
                    <div class="employee-select-btn">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            `).join('');
        }

        function selectEmployee(id, name, department, position) {
            selectedEmployee = { id, name, department, position };

            document.getElementById('selectedEmployeeName').textContent = name;
            document.getElementById('selectedEmployeeId').textContent = `${id} • ${department}`;
            document.getElementById('selectedEmployeeInfo').style.display = 'block';

            // Enable the continue button
            document.getElementById('continueToCameraBtn').disabled = false;

            // Add visual feedback to selected employee
            const employeeCards = document.querySelectorAll('.employee-card-compact');
            employeeCards.forEach(card => card.classList.remove('selected'));

            // Find the clicked card and add selected class
            const clickedCard = event.currentTarget || document.querySelector(`[onclick*="selectEmployee('${id}'"]`);
            if (clickedCard) {
                clickedCard.classList.add('selected');
            }

            showNotification(`Selected: ${name}`, 'success');
        }

        function searchEmployees() {
            const searchTerm = document.getElementById('employeeSearchInput').value.toLowerCase();

            // Filter employee list based on search
            const employeeCards = document.querySelectorAll('.employee-card-compact');
            employeeCards.forEach(card => {
                const name = card.querySelector('.employee-name-compact').textContent.toLowerCase();
                const id = card.querySelector('.employee-id-compact').textContent.toLowerCase();
                const dept = card.querySelector('.employee-dept-compact').textContent.toLowerCase();
                const visible = name.includes(searchTerm) || id.includes(searchTerm) || dept.includes(searchTerm);
                card.style.display = visible ? 'flex' : 'none';
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function initializeFaceTraining() {
            // Set up employee search
            const searchInput = document.getElementById('employeeSearchInput');
            searchInput.addEventListener('input', debounce(searchEmployees, 300));

            // Auto-load employees when modal opens
            loadEmployeesForTraining();
        }

        // Face Recognition Functions
        async function initializeFaceRecognition() {
            try {
                console.log('🚀 Initializing face recognition...');
                showNotification('Loading face recognition models...', 'info');

                if (typeof faceapi === 'undefined') {
                    throw new Error('Face-API.js library not loaded');
                }

                // Prefer WebGL if available for speed
                try {
                    if (faceapi.tf && faceapi.tf.setBackend) {
                        await faceapi.tf.setBackend('webgl');
                        await faceapi.tf.ready();
                        console.log('🧠 TensorFlow.js backend set to WebGL');
                    }
                } catch (e) {
                    console.warn('Falling back to default TF backend:', e);
                }

                const sources = [
                    '/face-models',
                    'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model',
                    'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights',
                    'https://unpkg.com/face-api.js@0.22.2/weights'
                ];

                async function loadAll(from) {
                    await Promise.all([
                        faceapi.nets.tinyFaceDetector.loadFromUri(from),
                        faceapi.nets.faceLandmark68Net.loadFromUri(from),
                        faceapi.nets.faceRecognitionNet.loadFromUri(from),
                        faceapi.nets.faceExpressionNet.loadFromUri(from)
                    ]);
                }

                let loaded = false;
                for (let i = 0; i < sources.length && !loaded; i++) {
                    const src = sources[i];
                    try {
                        console.log(`📦 Loading models from: ${src}`);
                        const statusEl = document.getElementById('faceModelsStatus');
                        if (statusEl) statusEl.innerHTML = `<span style="font-size: 0.75rem;">Loading models (${i+1}/${sources.length})...</span>`;
                        await loadAll(src);
                        loaded = true;
                    } catch (err) {
                        console.warn(`❌ Failed loading from ${src}:`, err);
                    }
                }
                if (!loaded) throw new Error('All model sources failed');

                isFaceApiLoaded = true;
                console.log('🎯 All face recognition models loaded successfully');

                // Update status indicator
                const statusEl = document.getElementById('faceModelsStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <i class="fas fa-check-circle" style="color: var(--success-500); font-size: 0.9rem;"></i>
                        <span style="font-size: 0.75rem; color: var(--success-600);">AI Models Ready</span>
                    `;
                }

                // Load saved face data
                await loadSavedFaces();

                showNotification('Face recognition ready!', 'success');

            } catch (error) {
                console.error('❌ Failed to load face recognition models:', error);
                isFaceApiLoaded = false;

                // Update status indicator to show error
                const statusEl = document.getElementById('faceModelsStatus');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="color: var(--danger-500); font-size: 0.9rem;"></i>
                        <span style="font-size: 0.75rem; color: var(--danger-600);">Models Failed</span>
                    `;
                }

                let errorMessage = 'Face recognition failed to load';
                if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage = 'Network error loading face models. Check your internet connection.';
                } else if (error.message.includes('Face-API.js')) {
                    errorMessage = 'Face-API.js library not found. Please refresh the page.';
                } else {
                    errorMessage = `Face recognition error: ${error.message}`;
                }

                showNotification(errorMessage, 'error');
            }
        }

        async function loadSavedFaces() {
            try {
                // Try localStorage first
                const savedFaces = localStorage.getItem('savedFaces');
                let totalLabels = 0;
                if (savedFaces) {
                    const faceData = JSON.parse(savedFaces);
                    labeledFaceDescriptors = faceData.map(face => {
                        const descriptors = face.descriptors.map(desc => new Float32Array(desc));
                        return new faceapi.LabeledFaceDescriptors(face.label, descriptors);
                    });
                    totalLabels = labeledFaceDescriptors.length;
                    console.log(`📚 Loaded ${totalLabels} saved faces from localStorage`);
                }

                // Fallback to backend if nothing in localStorage
                if (totalLabels === 0) {
                    try {
                        const res = await fetch('/employee/face-database', { credentials: 'include' });
                        if (res.ok) {
                            const serverFaces = await res.json();
                            // Group by name/label
                            const map = new Map();
                            serverFaces.forEach(item => {
                                const label = item.name || `EMP-${item.employee_id}`;
                                const arr = map.get(label) || [];
                                const desc = Array.isArray(item.descriptor) ? item.descriptor : [];
                                if (desc.length) arr.push(new Float32Array(desc));
                                map.set(label, arr);
                            });
                            labeledFaceDescriptors = Array.from(map.entries())
                                .filter(([, descs]) => descs.length)
                                .map(([label, descs]) => new faceapi.LabeledFaceDescriptors(label, descs));
                            totalLabels = labeledFaceDescriptors.length;
                            console.log(`📚 Loaded ${totalLabels} saved faces from server`);
                        }
                    } catch (serverErr) {
                        console.warn('Face DB fetch failed:', serverErr);
                    }
                }

                // Update trained faces count in stats
                const countEl = document.getElementById('trainedFacesCount');
                if (countEl) {
                    countEl.textContent = String(totalLabels);
                }

                // If camera already active and faces loaded, start recognition
                if (totalLabels > 0) {
                    const video = document.getElementById('faceVideo');
                    if (video && video.srcObject) {
                        setTimeout(() => startAutomaticFaceRecognition(), 300);
                    }
                }
            } catch (error) {
                console.error('❌ Failed to load saved faces:', error);

                // Reset count on error
                const countEl = document.getElementById('trainedFacesCount');
                if (countEl) {
                    countEl.textContent = '0';
                }
            }
        }

        // Automatic face recognition function
        async function startAutomaticFaceRecognition() {
            if (!isFaceApiLoaded) {
                console.log('Face recognition models not loaded yet, will retry...');
                setTimeout(startAutomaticFaceRecognition, 2000);
                return;
            }

            if (labeledFaceDescriptors.length === 0) {
                console.log('No trained faces available for recognition');
                return;
            }

            const video = document.getElementById('faceVideo');
            if (!video) {
                console.log('Video element not found');
                return;
            }

            // Check if already recognizing
            if (isRecognizing) {
                console.log('Face recognition already active');
                return;
            }

            // Wait for video to be ready
            if (video.readyState < 2) {
                console.log('Waiting for video stream to be ready...');
                await new Promise(resolve => video.addEventListener('loadeddata', resolve, { once: true }));
            }

            isRecognizing = true;
            console.log('🎯 Automatic face recognition started');

            // Create canvas for face detection overlay
            const canvas = document.createElement('canvas');
            canvas.id = 'faceRecognitionCanvas';
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'none';
            canvas.style.zIndex = '10';

            video.parentElement.appendChild(canvas);
            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // Start automatic recognition loop (requestAnimationFrame + frame skip)
            const ctx = canvas.getContext('2d');
            let frameCount = 0;
            let lastFpsTime = performance.now();
            let framesThisSecond = 0;
            const targetSkip = 1; // process every 2nd frame
            // Create FaceMatcher once
            let faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, FACE_MATCH_THRESHOLD);

            async function tick() {
                if (!isRecognizing) return;
                frameCount++;
                const now = performance.now();
                if (now - lastFpsTime >= 1000) {
                    // Optionally display FPS in UI (if element exists)
                    const fpsEl = document.getElementById('faceFps');
                    if (fpsEl) fpsEl.textContent = `${framesThisSecond} FPS`;
                    framesThisSecond = 0;
                    lastFpsTime = now;
                }

                if (frameCount % (targetSkip + 1) === 0) {
                    try {
                        const detections = await faceapi
                            .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                            .withFaceLandmarks()
                            .withFaceDescriptors();

                        const resizedDetections = faceapi.resizeResults(detections, displaySize);

                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        if (resizedDetections.length > 0) {
                            resizedDetections.forEach((detection) => {
                                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                                const box = detection.detection.box;
                                const isKnown = bestMatch.distance <= FACE_MATCH_THRESHOLD && bestMatch.label !== 'unknown';
                                ctx.strokeStyle = isKnown ? '#22c55e' : '#ef4444';
                                ctx.lineWidth = 2;
                                ctx.strokeRect(box.x, box.y, box.width, box.height);
                                ctx.fillStyle = isKnown ? '#22c55e' : '#ef4444';
                                ctx.font = '12px Inter, Arial';
                                const labelText = (isKnown ? bestMatch.label : 'Unknown') + ` (${bestMatch.distance.toFixed(2)})`;
                                ctx.fillText(labelText, box.x + 4, Math.max(12, box.y - 6));
                                if (isKnown) {
                                    handleAutomaticFaceRecognition(bestMatch.label, detection);
                                }
                            });
                        }
                        framesThisSecond++;
                    } catch (err) {
                        console.error('❌ Automatic face recognition error:', err);
                    }
                }

                requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        async function startFaceRecognition() {
            if (!isFaceApiLoaded) {
                showNotification('Face recognition not ready yet', 'error');
                return;
            }

            if (labeledFaceDescriptors.length === 0) {
                showNotification('No trained faces found. Please train faces first.', 'warning');
                return;
            }

            const video = document.getElementById('faceVideo');
            if (!video) {
                showNotification('Camera not active', 'error');
                return;
            }

            isRecognizing = true;

            // Update button states
            document.getElementById('startRecognitionBtn').disabled = true;
            document.getElementById('stopRecognitionBtn').disabled = false;
            document.getElementById('stopRecognitionBtn').style.display = 'inline-block';

            showNotification('🎯 Face recognition started', 'success');

            // Create canvas for face detection overlay
            const canvas = document.createElement('canvas');
            canvas.id = 'faceRecognitionCanvas';
            canvas.style.position = 'absolute';
            canvas.style.top = '0';
            canvas.style.left = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.pointerEvents = 'none';

            video.parentElement.appendChild(canvas);
            const displaySize = { width: video.offsetWidth, height: video.offsetHeight };
            faceapi.matchDimensions(canvas, displaySize);

            // Start recognition loop
            recognitionInterval = setInterval(async () => {
                if (!isRecognizing) return;

                try {
                    // Detect faces
                    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceDescriptors();

                    // Resize detections to match display size
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);

                    // Clear canvas
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    if (resizedDetections.length > 0) {
                        // Create face matcher with saved faces
                        const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, FACE_MATCH_THRESHOLD);

                        // Recognize faces
                        resizedDetections.forEach((detection, index) => {
                            const bestMatch = faceMatcher.findBestMatch(detection.descriptor);

                            // Draw face bounding box
                            const box = detection.detection.box;
                            ctx.strokeStyle = bestMatch.distance <= FACE_MATCH_THRESHOLD ? '#00ff00' : '#ff0000';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(box.x, box.y, box.width, box.height);

                            // Draw recognition result
                            ctx.fillStyle = bestMatch.distance <= FACE_MATCH_THRESHOLD ? '#00ff00' : '#ff0000';
                            ctx.fillRect(box.x, box.y - 30, box.width, 30);

                            ctx.fillStyle = '#ffffff';
                            ctx.font = '14px Arial';
                            ctx.fillText(
                                (bestMatch.distance <= FACE_MATCH_THRESHOLD ? bestMatch.label : 'Unknown') + ` (${bestMatch.distance.toFixed(2)})`,
                                box.x + 5,
                                box.y - 10
                            );

                            // If face recognized, record attendance
                            if (bestMatch.distance <= FACE_MATCH_THRESHOLD && bestMatch.label !== 'unknown') {
                                handleFaceRecognition(bestMatch.label, detection);
                            }
                        });
                    }

                } catch (error) {
                    console.error('❌ Face recognition error:', error);
                }
            }, 100); // Check every 100ms
        }

        function handleFaceRecognition(employeeName, detection) {
            // Prevent duplicate recordings within short time
            const now = Date.now();
            const lastRecognition = localStorage.getItem(`lastRecognition_${employeeName}`);

            if (lastRecognition && (now - parseInt(lastRecognition)) < 5000) {
                return; // Already recorded within last 5 seconds
            }

            // Also prevent multiple marks in a single session
            if (hasMarkedThisSession) return;

            // Record attendance
            localStorage.setItem(`lastRecognition_${employeeName}`, now.toString());

            const scanEntry = {
                type: 'Face Recognition',
                data: `Employee: ${employeeName}`,
                timestamp: new Date().toISOString(),
                mode: 'Face',
                confidence: Math.round((1 - detection.descriptor) * 100) + '%'
            };

            scanHistory.unshift(scanEntry);
            saveScanHistory();
            updateScanHistoryUI();
            updateStats();

            showNotification(`✅ Recognized: ${employeeName}`, 'success');
            showScanSuccess('face');
            hasMarkedThisSession = true;
            setTimeout(() => { try { stopFaceRecognition(); } catch(_){} try { stopFaceScanner(); } catch(_){} }, 750);
        }

        // Robust automatic recognition handler with attendance
        async function handleAutomaticFaceRecognition(label, detection) {
            try {
                if (hasMarkedThisSession) return; // one mark per session
                // Debounce per-identity for 8 seconds
                const key = `auto_recognition_${label}`;
                const now = Date.now();
                const last = parseInt(localStorage.getItem(key) || '0', 10);
                if (now - last < 8000) return;
                localStorage.setItem(key, String(now));

                // Try to extract numeric employee ID from saved faces (label might be name)
                const savedFaces = JSON.parse(localStorage.getItem('savedFaces') || '[]');
                const match = savedFaces.find(f => f.label === label);
                let employeeId = match && match.employeeId ? match.employeeId : null;
                // Normalize non-numeric IDs (e.g., EMP002) by resolving via backend
                if (!employeeId || isNaN(Number(employeeId))) {
                    const resolved = await resolveEmployeeIdByLabel(label);
                    if (resolved) {
                        employeeId = resolved;
                        // Update savedFaces mapping for future
                        const updated = savedFaces.map(f => f.label === label ? { ...f, employeeId: employeeId } : f);
                        localStorage.setItem('savedFaces', JSON.stringify(updated));
                    }
                }

                if (employeeId) {
                    // Attempt to mark attendance
                    const res = await fetch('/attendance/mark', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ employee_id: employeeId })
                    });
                    if (res.ok) {
                        const result = await res.json();
                        showNotification(`✅ ${label}: ${result.status}`, 'success');
                        showScanSuccess('face');
                        hasMarkedThisSession = true;
                        setTimeout(() => { try { stopFaceRecognition(); } catch(_){} try { stopFaceScanner(); } catch(_){} }, 750);
                        return;
                    } else if (res.status === 401) {
                        // Not logged in - just notify locally
                        showNotification(`✅ Recognized: ${label}. Please sign in to record attendance.`, 'warning');
                        showScanSuccess('face');
                        hasMarkedThisSession = true;
                        setTimeout(() => { try { stopFaceRecognition(); } catch(_){} try { stopFaceScanner(); } catch(_){} }, 750);
                        return;
                    } else {
                        const err = await res.json().catch(() => ({}));
                        console.warn('Attendance mark failed:', err);
                        showNotification(`Recognized ${label}, but attendance failed`, 'warning');
                        // Still stop to avoid multiple marks
                        showScanSuccess('face');
                        hasMarkedThisSession = true;
                        setTimeout(() => { try { stopFaceRecognition(); } catch(_){} try { stopFaceScanner(); } catch(_){} }, 750);
                        return;
                    }
                } else {
                    // Fallback: local notification only
                    showNotification(`✅ Recognized: ${label}`, 'success');
                    showScanSuccess('face');
                    hasMarkedThisSession = true;
                    setTimeout(() => { try { stopFaceRecognition(); } catch(_){} try { stopFaceScanner(); } catch(_){} }, 750);
                    return;
                }
            } catch (error) {
                console.error('handleAutomaticFaceRecognition error:', error);
            }
        }

        async function resolveEmployeeIdByLabel(label) {
            try {
                // Try exact search endpoint
                const q = encodeURIComponent(label);
                const res = await fetch(`/employee/search?q=${q}`);
                if (res.ok) {
                    const data = await res.json();
                    const exact = (data.employees || []).find(e => (e.name || '').toLowerCase() === label.toLowerCase());
                    if (exact) return exact.employee_id || exact.id;
                    const first = (data.employees || [])[0];
                    if (first) return first.employee_id || first.id;
                }
            } catch (_) {}
            try {
                // Fallback to list and find by name
                const list = await fetch('/employee/list');
                if (list.ok) {
                    const data = await list.json();
                    const exact = (data.employees || []).find(e => (e.name || '').toLowerCase() === label.toLowerCase());
                    if (exact) return exact.employee_id || exact.id;
                }
            } catch (_) {}
            return null;
        }

        function stopFaceRecognition() {
            isRecognizing = false;
            if (recognitionInterval) {
                clearInterval(recognitionInterval);
                recognitionInterval = null;
            }

            // Remove canvas overlay
            const canvas = document.getElementById('faceRecognitionCanvas');
            if (canvas) {
                canvas.remove();
            }

            // Reset button states
            document.getElementById('startRecognitionBtn').disabled = false;
            document.getElementById('stopRecognitionBtn').disabled = true;
            document.getElementById('stopRecognitionBtn').style.display = 'none';

            showNotification('Face recognition stopped', 'info');
        }

        function goToWizardStep(step) {
            // Update progress
            document.getElementById('currentStepText').textContent = `Step ${step} of 4`;
            document.getElementById('progressFill').style.width = `${(step / 4) * 100}%`;

            // Update step indicators
            document.querySelectorAll('.wizard-step').forEach((stepEl, index) => {
                const stepNumber = index + 1;
                if (stepNumber < step) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                } else if (stepNumber === step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                } else {
                    stepEl.classList.remove('active', 'completed');
                }
            });

            // Show/hide content
            document.querySelectorAll('.wizard-content').forEach((content, index) => {
                content.classList.toggle('active', index + 1 === step);
            });
        }

        function proceedToCameraSetup() {
            if (!selectedEmployee) {
                showNotification('Please select an employee first', 'error');
                return;
            }

            goToWizardStep(2);
            initializeCameraSetup();
        }

        async function initializeCameraSetup() {
            try {
                updateCameraStatus('Requesting camera permission...', 'status-warning');

                // Check if camera is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera not supported on this device');
                }

                updateCameraStatus('Initializing camera...', 'status-warning');

                // Request camera access with optimized settings for speed
                const constraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: 480, min: 320 },
                        height: { ideal: 360, min: 240 },
                        frameRate: { ideal: 20, min: 10 }
                    },
                    audio: false
                };

                setupCameraStream = await navigator.mediaDevices.getUserMedia(constraints);

                updateCameraStatus('Setting up camera preview...', 'status-warning');

                const container = document.getElementById('setupCameraContainer');
                container.innerHTML = `
                    <video id="setupVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);"></video>
                `;

                const video = document.getElementById('setupVideo');
                video.srcObject = setupCameraStream;

                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                updateCameraStatus('Camera ready! ✅', 'status-online');
                document.getElementById('proceedToCaptureBtn').disabled = false;

                isCameraReady = true;
                showNotification('Camera ready! Click "Start Capturing Images" 📹', 'success');

            } catch (error) {
                console.error('Camera setup error:', error);
                let errorMessage = 'Failed to access camera';

                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Camera access denied. Please allow camera permissions and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No camera found on this device.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Camera is already in use by another application.';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = 'Camera does not meet the required specifications.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'Camera access blocked due to security restrictions.';
                }

                updateCameraStatus('Camera access failed ❌', 'status-error');
                showNotification(errorMessage, 'error');
            }
        }



        function updateCameraStatus(text, statusClass) {
            const statusIcon = document.getElementById('cameraStatus');
            const statusText = document.getElementById('cameraStatusText');

            if (statusIcon && statusText) {
                statusIcon.className = `fas fa-circle ${statusClass}`;
                statusText.textContent = text;
            }
        }

        function proceedToCapture() {
            if (!isCameraReady || !setupCameraStream) {
                showNotification('Camera not ready for capture', 'error');
                return;
            }

            goToWizardStep(3);
            initializeImageCapture();
        }

        async function initializeImageCapture() {
            try {
                // Stop setup camera and start capture camera
                if (setupCameraStream) {
                    setupCameraStream.getTracks().forEach(track => track.stop());
                }

                showNotification('Setting up camera...', 'info');

                // Initialize capture camera with optimized settings for speed
                const captureConstraints = {
                    video: {
                        facingMode: 'user',
                        width: { ideal: 640, min: 480 },
                        height: { ideal: 480, min: 360 },
                        frameRate: { ideal: 20, min: 10 }
                    },
                    audio: false
                };

                captureCameraStream = await navigator.mediaDevices.getUserMedia(captureConstraints);

                const container = document.getElementById('captureCameraContainer');
                container.innerHTML = `
                    <video id="captureVideo" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-xl);"></video>
                `;

                const video = document.getElementById('captureVideo');
                video.srcObject = captureCameraStream;

                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });

                trainingStartTime = new Date();
                updateCaptureProgress();

                showNotification('Ready to capture photos! 📸', 'success');

            } catch (error) {
                console.error('Capture camera error:', error);
                showNotification('Failed to initialize capture camera: ' + error.message, 'error');
            }
        }

        async function captureTrainingImage() {
            if (!captureCameraStream) {
                showNotification('Camera not ready for capture', 'error');
                return;
            }

            try {
                const video = document.getElementById('captureVideo');
                if (!video) {
                    showNotification('Camera preview not available', 'error');
                    return;
                }

                // Create canvas for image capture
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                // Convert to blob for storage (lower quality for faster processing)
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'image/jpeg', 0.7);
                });

                // Create image object
                const imageData = {
                    blob: blob,
                    dataUrl: canvas.toDataURL('image/jpeg', 0.7),
                    step: currentInstructionStep,
                    timestamp: new Date().toISOString()
                };

                trainingImages.push(imageData);

                // Add thumbnail
                addImageThumbnail(imageData);

                // Update progress
                updateCaptureProgress();

                // Move to next instruction or complete
                if (trainingImages.length < 4) {
                    updateInstructionStep(currentInstructionStep + 1);
                    showNotification(`Image ${trainingImages.length} captured! 📸`, 'success');
                } else {
                    showNotification('All images captured! 🎉 Ready for review.', 'success');
                    setTimeout(() => {
                        goToWizardStep(4);
                        prepareReviewStep();
                    }, 1000);
                }

            } catch (error) {
                console.error('Image capture error:', error);
                showNotification('Failed to capture image: ' + error.message, 'error');
            }
        }

        function addImageThumbnail(imageData) {
            const container = document.getElementById('thumbnailsGrid');
            const thumbnail = document.createElement('div');
            thumbnail.className = 'image-thumbnail';
            thumbnail.innerHTML = `
                <img src="${imageData.dataUrl}" alt="Training image ${imageData.step}" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-md);">
                <div class="thumbnail-step">${imageData.step}</div>
            `;

            container.appendChild(thumbnail);
        }

        function updateCaptureProgress() {
            const captured = trainingImages.length;
            const required = 4;
            const percentage = Math.round((captured / required) * 100);

            document.getElementById('capturedCount').textContent = captured;
            document.getElementById('requiredCount').textContent = required;
            document.getElementById('progressPercentage').textContent = `${percentage}%`;
            document.getElementById('captureProgressFill').style.width = `${percentage}%`;

            // Enable/disable retake button
            const retakeBtn = document.getElementById('retakeLastBtn');
            if (retakeBtn) {
                retakeBtn.disabled = captured === 0;
            }
        }

        function retakeLastImage() {
            if (trainingImages.length > 0) {
                trainingImages.pop();
                updateCaptureProgress();

                // Remove last thumbnail
                const container = document.getElementById('thumbnailsGrid');
                if (container.lastChild) {
                    container.removeChild(container.lastChild);
                }

                // Update instruction step
                updateInstructionStep(Math.max(1, trainingImages.length + 1));

                showNotification('Last image removed. Take a better one!', 'info');
            }
        }

        function updateInstructionStep(step) {
            currentInstructionStep = step;

            // Update active instruction
            document.querySelectorAll('.instruction-item').forEach((item, index) => {
                item.classList.toggle('active', index + 1 === step);
            });

            // Update button text
            const buttonText = document.getElementById('captureButtonText');
            if (buttonText) {
                const instructions = [
                    'Front View',
                    'With Smile',
                    'Neutral',
                    'Final Check'
                ];

                buttonText.textContent = `Capture ${instructions[step - 1] || 'Image'}`;
            }
        }

        function prepareReviewStep() {
            // Populate review information
            const employeeNameEl = document.getElementById('reviewEmployeeName');
            const imageCountEl = document.getElementById('reviewImageCount');
            const trainingTimeEl = document.getElementById('reviewTrainingTime');

            if (employeeNameEl) employeeNameEl.textContent = selectedEmployee?.name || 'Unknown';
            if (imageCountEl) imageCountEl.textContent = `${trainingImages.length} images`;

            // Calculate training time
            if (trainingTimeEl) {
                const trainingTime = Math.round((new Date() - trainingStartTime) / 1000);
                trainingTimeEl.textContent = `${Math.floor(trainingTime / 60)}m ${trainingTime % 60}s`;
            }

            // Add all images to review gallery
            const container = document.getElementById('reviewImagesGrid');
            if (container) {
                container.innerHTML = '';

                trainingImages.forEach((image, index) => {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'review-image-item';
                    imgDiv.innerHTML = `
                        <img src="${image.dataUrl}" alt="Training image ${index + 1}" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-lg);">
                        <div class="review-image-step">${image.step}</div>
                    `;
                    container.appendChild(imgDiv);
                });
            }
        }

        async function completeTraining() {
            try {
                const button = document.getElementById('completeTrainingBtn');
                const buttonText = document.getElementById('completeButtonText');

                if (button) button.disabled = true;
                if (buttonText) buttonText.textContent = 'Saving...';

                // Get options
                const enhanceQuality = document.getElementById('enhanceQuality')?.checked || false;
                const testRecognition = document.getElementById('testRecognition')?.checked || false;

                // Simulate faster saving process
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Save face descriptors for recognition
                if (trainingImages.length > 0) {
                    // Show loading overlay
                    showProcessingOverlay('Processing face data...', 'This may take a few seconds...');

                    try {
                        await saveFaceDescriptors(selectedEmployee, trainingImages);
                    } finally {
                        // Hide loading overlay
                        hideProcessingOverlay();
                    }
                }

                // Here you would send the images to your backend API
                console.log('Training data:', {
                    employee: selectedEmployee,
                    images: trainingImages,
                    options: { enhanceQuality, testRecognition }
                });

                showNotification('Face training completed successfully! 🎉', 'success');

                // Clean up
                closeFaceTrainingModal();

                // Reset training state
                if (button) button.disabled = false;
                if (buttonText) buttonText.textContent = 'Complete Training';

                // Show recognition buttons now that faces are trained
                document.getElementById('startRecognitionBtn').style.display = 'inline-block';
                document.getElementById('startRecognitionBtn').disabled = false;

            } catch (error) {
                console.error('Training completion error:', error);
                showNotification('Failed to complete training: ' + error.message, 'error');

                const button = document.getElementById('completeTrainingBtn');
                const buttonText = document.getElementById('completeButtonText');
                if (button) button.disabled = false;
                if (buttonText) buttonText.textContent = 'Complete Training';
            }
        }

        async function saveFaceDescriptors(employee, images) {
            try {
                console.log('🚀 Starting face descriptor processing...');
                showNotification('Processing face data...', 'info');

                // Check if face-api is loaded
                if (!isFaceApiLoaded) {
                    console.error('❌ Face-API not loaded');
                    showNotification('Face recognition not ready. Please refresh the page.', 'error');
                    return;
                }

                const descriptors = [];
                const targetDescriptors = Math.min(3, images.length); // early stop once enough descriptors
                let processedCount = 0;

                // Process each image to extract face descriptors
                for (let i = 0; i < images.length; i++) {
                    const imageData = images[i];

                    try {
                        console.log(`📸 Processing image ${i + 1}/${images.length}...`);

                        // Create image element from data URL
                        const img = new Image();
                        img.src = imageData.dataUrl;

                        // Add timeout to image loading
                        const imageLoadPromise = new Promise((resolve, reject) => {
                            img.onload = () => resolve();
                            img.onerror = () => reject(new Error('Failed to load image'));
                            // Timeout after 3 seconds (faster failover)
                            setTimeout(() => reject(new Error('Image load timeout')), 3000);
                        });

                        await imageLoadPromise;

                        console.log(`✅ Image ${i + 1} loaded successfully`);

                        // Downscale image for faster inference (max side 320px)
                        const maxSide = 320;
                        const scale = Math.min(1, maxSide / Math.max(img.width, img.height));
                        const dw = Math.max(1, Math.round(img.width * scale));
                        const dh = Math.max(1, Math.round(img.height * scale));
                        const off = document.createElement('canvas');
                        off.width = dw;
                        off.height = dh;
                        const octx = off.getContext('2d');
                        octx.drawImage(img, 0, 0, dw, dh);

                        // Detect face and extract descriptor
                        const detection = await faceapi.detectSingleFace(off, new faceapi.TinyFaceDetectorOptions({
                            inputSize: 224,
                            scoreThreshold: 0.5
                        }))
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                        if (detection && detection.descriptor) {
                            descriptors.push(Array.from(detection.descriptor));
                            processedCount++;
                            console.log(`🎯 Face descriptor extracted for image ${i + 1}`);
                            // Early stop if we already have enough descriptors
                            if (descriptors.length >= targetDescriptors) {
                                console.log('⏭️ Reached target descriptor count. Stopping early.');
                                break;
                            }
                        } else {
                            console.warn(`⚠️ No face detected in image ${i + 1}`);
                        }

                    } catch (imageError) {
                        console.error(`❌ Error processing image ${i + 1}:`, imageError);
                        // Continue with next image instead of failing completely
                        continue;
                    }
                }

                console.log(`📊 Processing complete: ${processedCount}/${images.length} images successful`);

                if (descriptors.length === 0) {
                    console.error('❌ No faces detected in any training images');
                    showNotification('No faces detected in training images. Please retake photos with clearer face visibility.', 'warning');
                    return;
                }

                if (descriptors.length < 2) {
                    console.warn('⚠️ Only one face descriptor extracted - recognition may be less accurate');
                    showNotification('Only one face processed. Consider retraining with more photos for better accuracy.', 'warning');
                }

                // Save face descriptors
                const faceData = {
                    label: employee.name,
                    descriptors: descriptors,
                    employeeId: employee.id,
                    trainedAt: new Date().toISOString(),
                    imageCount: images.length,
                    descriptorCount: descriptors.length
                };

                console.log('💾 Saving face data to localStorage...');

                // Load existing faces and add new one
                const savedFaces = localStorage.getItem('savedFaces');
                let facesArray = savedFaces ? JSON.parse(savedFaces) : [];

                // Remove existing entry for this employee if exists
                facesArray = facesArray.filter(face => face.employeeId !== employee.id);

                // Add new face data
                facesArray.push(faceData);

                // Save back to localStorage
                localStorage.setItem('savedFaces', JSON.stringify(facesArray));

                // Update labeled face descriptors for immediate recognition
                labeledFaceDescriptors = facesArray.map(face => {
                    const descs = face.descriptors.map(desc => new Float32Array(desc));
                    return new faceapi.LabeledFaceDescriptors(face.label, descs);
                });

                console.log(`✅ Face training completed for ${employee.name} (${descriptors.length} descriptors from ${images.length} images)`);
                showNotification(`Face training saved! Can now recognize ${employee.name} (${descriptors.length} descriptors)`, 'success');

            } catch (error) {
                console.error('❌ Critical error in saveFaceDescriptors:', error);
                showNotification(`Failed to process face data: ${error.message}`, 'error');

                // Provide helpful debugging info
                if (error.message.includes('Face-API')) {
                    showNotification('Face recognition models not loaded. Please refresh the page and try again.', 'error');
                } else if (error.message.includes('timeout')) {
                    showNotification('Processing timed out. Try with fewer or clearer images.', 'error');
                }
            }
        }

        function restartTraining() {
            if (confirm('Are you sure you want to restart the training process? All progress will be lost.')) {
                closeFaceTrainingModal();
                setTimeout(() => {
                    showFaceTrainingModal();
                }, 300);
            }
        }

        // Processing Overlay Functions
        function showProcessingOverlay(title, message) {
            // Remove existing overlay
            hideProcessingOverlay();

            const overlay = document.createElement('div');
            overlay.id = 'processingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                backdrop-filter: blur(5px);
            `;

            overlay.innerHTML = `
                <div style="
                    background: white;
                    padding: 2rem;
                    border-radius: var(--radius-xl);
                    text-align: center;
                    box-shadow: var(--shadow-xl);
                    max-width: 400px;
                    width: 90%;
                ">
                    <div style="
                        width: 50px;
                        height: 50px;
                        border: 4px solid var(--surface-200);
                        border-top: 4px solid var(--primary-500);
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 1rem;
                    "></div>
                    <h3 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">${title}</h3>
                    <p style="margin: 0; color: var(--text-secondary);">${message}</p>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;

            document.body.appendChild(overlay);
        }

        function hideProcessingOverlay() {
            const overlay = document.getElementById('processingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function saveFaceTraining() {
            showNotification('Face training data saved successfully!', 'success');
            closeFaceTrainingModal();
        }

        // Utility Functions
        function updateStatus(type, status, text) {
            const statusElement = document.getElementById(`${type}Status`);
            statusElement.className = `status-indicator status-${status}`;
            statusElement.querySelector('span').textContent = text;
        }

        function showScanSuccess(type) {
            const overlay = document.getElementById(`${type}SuccessOverlay`);
            overlay.classList.add('show');

            setTimeout(() => {
                overlay.classList.remove('show');
            }, 2000);
        }

        function loadScanHistory() {
            const history = localStorage.getItem('scannerHistory');
            if (history) {
                scanHistory = JSON.parse(history);
                updateScanHistoryUI();
            }
        }

        function saveScanHistory() {
            localStorage.setItem('scannerHistory', JSON.stringify(scanHistory));
        }

        function updateScanHistoryUI() {
            const container = document.getElementById('scanList');

            if (scanHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 2rem 1rem; text-align: center;">
                        <i class="fas fa-inbox" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 0.5rem;"></i>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">No scans yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = scanHistory.slice(0, 5).map((scan, index) => `
                <div class="scan-item">
                    <div class="scan-icon scan-icon-${scan.type.toLowerCase().replace(' ', '-') === 'qr code' ? 'qr' : scan.type.toLowerCase() === 'manual entry' ? 'manual' : 'face'}">
                        <i class="fas fa-${scan.type === 'QR Code' ? 'qrcode' : scan.type === 'Manual Entry' ? 'keyboard' : 'user'}"></i>
                    </div>
                    <div class="scan-content">
                        <div class="scan-info">${scan.data}</div>
                        <div class="scan-time">${new Date(scan.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="scan-actions">
                        <button class="scan-action-btn" onclick="deleteScan(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            document.getElementById('todayScans').textContent = scanHistory.filter(scan =>
                new Date(scan.timestamp).toDateString() === new Date().toDateString()
            ).length;

            document.getElementById('activeUsers').textContent = new Set(
                scanHistory.map(scan => scan.data.split('Employee: ')[1]?.split(',')[0]).filter(Boolean)
            ).size;

            const successRate = scanHistory.length > 0 ?
                Math.round((scanHistory.filter(scan => scan.success).length / scanHistory.length) * 100) : 0;
            document.getElementById('successRate').textContent = `${successRate}%`;

            document.getElementById('avgTime').textContent = '<2s';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 400px;
            `;

            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function clearScanHistory() {
            if (confirm('Are you sure you want to clear all scan history?')) {
                scanHistory = [];
                saveScanHistory();
                updateScanHistoryUI();
                updateStats();
                showNotification('Scan history cleared', 'success');
            }
        }

        function exportScanHistory() {
            if (scanHistory.length === 0) {
                showNotification('No scan history to export', 'warning');
                return;
            }

            const csv = [
                ['Type', 'Data', 'Timestamp', 'Mode', 'Success'],
                ...scanHistory.map(scan => [
                    scan.type,
                    scan.data,
                    scan.timestamp,
                    scan.mode,
                    scan.success ? 'Yes' : 'No'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scan-history-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);

            showNotification('Scan history exported successfully', 'success');
        }

        function deleteScan(index) {
            if (confirm('Are you sure you want to delete this scan?')) {
                scanHistory.splice(index, 1);
                saveScanHistory();
                updateScanHistoryUI();
                updateStats();
                showNotification('Scan deleted', 'success');
            }
        }

        function refreshScanner() {
            // Refresh scanner stats and status
            updateStats();
            showNotification('Scanner refreshed', 'success');
        }

        function showSystemInfo() {
            const info = `
System Information:
• Browser: ${navigator.userAgent.split(' ').pop()}
• Camera: ${navigator.mediaDevices ? 'Supported' : 'Not Supported'}
• QR Scanner: Ready
• Database: Connected
• Last Updated: ${new Date().toLocaleString()}
            `;
            alert(info);
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                // Stop any active scanners
                stopQrScanner();
                stopFaceScanner();

                // Clear local data
                localStorage.removeItem('scannerHistory');

                window.location.href = 'signin.html';
            }
        }
    </script>
    <script>
    // Attach nav language toggle for scanner page
    (function(){
      const dict = {
        en: { dashboard:'Dashboard', employees:'Employees', scanner:'Scanner', reports:'Reports', logout:'Logout' },
        am: { dashboard:'ዳሽቦርድ', employees:'ሰራተኞች', scanner:'ስካነር', reports:'ሪፖርቶች', logout:'መውጣት' }
      };
      function applyLang(lang){
        document.querySelectorAll('[data-i18n]').forEach(el=>{
          const key = el.getAttribute('data-i18n');
          if (dict[lang] && dict[lang][key]) el.textContent = dict[lang][key];
        });
        localStorage.setItem('lang', lang);
      }
      const btn = document.getElementById('langToggleNav');
      if (btn) btn.onclick = ()=>{ const next=(localStorage.getItem('lang')||'en')==='en'?'am':'en'; applyLang(next); };
      applyLang(localStorage.getItem('lang')||'en');
    })();
    </script>
</body>
<script>
(function(){
    const base = window.location.origin.includes(':5000') ? window.location.origin : 'http://localhost:5000';
    const navLinks = [
        ['a.nav-link[href="dashboard.html"]', '/dashboard.html'],
        ['a.nav-link[href="employees.html"]', '/employees.html'],
        ['a.nav-link[href="scanner.html"]', '/scanner.html'],
        ['a.nav-link[href="reports.html"]', '/reports.html']
    ];
    navLinks.forEach(([sel, path]) => {
        const el = document.querySelector(sel);
        if (el) el.href = base + path;
    });
})();
</script>
</html>
