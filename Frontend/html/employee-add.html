<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Employee - Smart Attendance System</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .page { max-width: 720px; margin: 0 auto; padding: 2rem 1rem; }
        .card { background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: var(--radius-2xl); box-shadow: var(--shadow-lg); padding: 2rem; }
        .header { display:flex; align-items:center; gap:.75rem; margin-bottom:1.5rem; }
        .header h1 { margin:0; font-size:1.5rem; }
        .grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
        .grid .full { grid-column: 1 / -1; }
        .form-group label { display:block; margin-bottom:.5rem; font-weight:600; }
        .form-group input, .form-group select { width:100%; padding:.75rem; border:2px solid var(--surface-300); border-radius: var(--radius-lg); background: var(--surface-50); }
        .actions { display:flex; gap:.75rem; justify-content:flex-end; margin-top:1rem; }
        .note { color: var(--text-muted); font-size:.9rem; margin-top:.5rem; }

        /* Modal for QR + Face Scan */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: #fff; border-radius: 1rem; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 1.25rem; box-shadow: var(--shadow-lg); }
        .modal-header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 1rem; }
        .modal-header h3 { margin: 0; }
        .modal-close { border: none; background: transparent; font-size: 1.25rem; cursor: pointer; }
        .qr-preview { text-align: center; margin: 1rem 0; }
        .qr-preview img { max-width: 280px; height: auto; border: 1px solid #e5e7eb; border-radius: .5rem; }
        .face-section { background: var(--surface-50); border: 1px solid var(--surface-200); border-radius: .75rem; padding: 1rem; }
        .face-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .video-box, .captures-box { background: #fff; border: 1px solid var(--surface-200); border-radius: .5rem; padding: .75rem; }
        .captures-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: .5rem; }
        .captures-list img { width: 100%; border-radius: .25rem; border: 1px solid #e5e7eb; }
        .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.65rem 1rem; border-radius:.5rem; border:none; cursor:pointer; font-weight:600; }
        .btn-primary { background: #3b82f6; color:#fff; }
        .btn-outline { background:#f3f4f6; color:#111827; }
        .btn:disabled { opacity:.6; cursor:not-allowed; }
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('employeeAddForm');
        let currentEmployeeId = null;
        let mediaStream = null;
        const maxCaptures = 3;
        const captures = [];

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submit = form.querySelector('button[type="submit"]');
            const data = Object.fromEntries(new FormData(form).entries());
            if (!data.name || !data.email || !data.phone) {
                showToast('Name, Email, and Phone are required', 'error');
                return;
            }
            submit.disabled = true; submit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            try {
                const res = await fetch('/employee/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: data.name.trim(),
                        email: data.email.trim(),
                        phone: data.phone.trim(),
                        position: (data.position||'').trim(),
                        department: data.department || ''
                    })
                });
                const json = await res.json();
                if (!res.ok) throw new Error(json.error || 'Failed to add employee');
                currentEmployeeId = json.employee_id;
                showToast('Employee registered successfully!', 'success');
                // Always fetch a fresh QR from server to ensure image is available
                let qrImage = json.qr_code || '';
                try {
                    const qrRes = await fetch(`/employee/generate-qr/${currentEmployeeId}`, { method: 'POST', credentials: 'include' });
                    const qrJson = await qrRes.json();
                    if (qrRes.ok && qrJson.success && qrJson.qr_code) {
                        qrImage = qrJson.qr_code;
                    }
                } catch (_) { /* ignore and use any existing */ }
                showQRAndFaceModal(qrImage, data.name, json.employee_id);
                // Update inline panel for immediate visibility as well
                const pnl = document.getElementById('qrInlinePanel');
                const img = document.getElementById('qrInlineImg');
                const lnk = document.getElementById('qrInlineLink');
                const ob = document.getElementById('qrInlineOpenBtn');
                const mt = document.getElementById('qrInlineMeta');
                if (pnl && img) {
                    if (qrImage) {
                        img.src = qrImage;
                        if (lnk) lnk.href = qrImage;
                        if (ob) ob.href = qrImage;
                    }
                    if (mt) mt.textContent = `Employee: ${data.name}  •  ID: ${json.employee_id}`;
                    pnl.style.display = 'block';
                    window.scrollTo({ top: pnl.offsetTop - 80, behavior: 'smooth' });
                }
            } catch (err) {
                showToast(err.message || 'Registration failed', 'error');
            } finally {
                submit.disabled = false; submit.innerHTML = '<i class="fas fa-save"></i> Save Employee';
            }
        });

        function showQRAndFaceModal(qrData, employeeName, employeeId) {
            const modal = document.getElementById('qrFaceModal');
            const qrImg = document.getElementById('qrImage');
            const qrLink = document.getElementById('qrLink');
            const qrOpenBtn = document.getElementById('qrOpenBtn');
            const meta = document.getElementById('qrMeta');
            qrImg.src = qrData || '';
            if (qrData) {
                if (qrLink) qrLink.href = qrData;
                if (qrOpenBtn) qrOpenBtn.href = qrData;
            }
            meta.textContent = `Employee: ${employeeName}  •  ID: ${employeeId}`;
            modal.style.display = 'flex';
        }

        async function startCamera() {
            try {
                if (mediaStream) return;
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 }, facingMode: 'user' }, audio: false });
                const video = document.getElementById('camera');
                video.srcObject = mediaStream;
                await video.play();
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('startBtn').disabled = true;
            } catch (e) {
                alert('Camera error: ' + e.message);
            }
        }

        function captureFrame() {
            const video = document.getElementById('camera');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
            if (captures.length < maxCaptures) {
                captures.push(dataUrl);
                renderCaptures();
            }
            if (captures.length >= maxCaptures) {
                document.getElementById('captureBtn').disabled = true;
                document.getElementById('saveFacesBtn').disabled = false;
            }
        }

        function renderCaptures() {
            const list = document.getElementById('captures');
            list.innerHTML = captures.map(src => `<img src="${src}" alt="capture">`).join('');
        }

        async function saveFaces() {
            if (!currentEmployeeId || captures.length === 0) {
                showToast('No captures to save', 'error');
                return;
            }
            const btn = document.getElementById('saveFacesBtn');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            try {
                const res = await fetch('/employee/train-face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        employee_id: currentEmployeeId,
                        face_images: captures,
                        timestamp: new Date().toISOString()
                    })
                });
                const json = await res.json();
                if (!res.ok) throw new Error(json.error || 'Failed to save face data');
                showToast('Face training saved successfully', 'success');
                closeModalAndCleanup();
                window.location.href = '/employees.html';
            } catch (e) {
                showToast(e.message || 'Failed to save face data', 'error');
                btn.disabled = false; btn.innerHTML = 'Save & Finish';
            }
        }

        function closeModalAndCleanup() {
            const modal = document.getElementById('qrFaceModal');
            modal.style.display = 'none';
            if (mediaStream) { mediaStream.getTracks().forEach(t => t.stop()); mediaStream = null; }
            captures.splice(0, captures.length);
            document.getElementById('captures').innerHTML = '';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('captureBtn').disabled = true;
            document.getElementById('saveFacesBtn').disabled = true; document.getElementById('saveFacesBtn').innerHTML = 'Save & Finish';
        }

        // Expose modal controls
        window._startCamera = startCamera;
        window._captureFrame = captureFrame;
        window._saveFaces = saveFaces;
        window._closeModal = closeModalAndCleanup;
        window._downloadQR = function downloadQR(imgId){
            try {
                const targetId = imgId || 'qrImage';
                const img = document.getElementById(targetId);
                if (!img || !img.src) { showToast('QR not available yet', 'error'); return; }
                const a = document.createElement('a');
                a.href = img.src;
                a.download = 'employee-qr.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (e) { showToast('Failed to download QR', 'error'); }
        };
        window._regenerateQR = async function regenerateQR(){
            try {
                if (!currentEmployeeId) { showToast('Save employee first', 'error'); return; }
                const res = await fetch(`/employee/generate-qr/${currentEmployeeId}`, { method:'POST', credentials:'include' });
                const json = await res.json();
                if (res.ok && json.success && json.qr_code) {
                    document.getElementById('qrImage').src = json.qr_code;
                    const inlineImg = document.getElementById('qrInlineImg');
                    const inlineLink = document.getElementById('qrInlineLink');
                    const inlineOpen = document.getElementById('qrInlineOpenBtn');
                    if (inlineImg) inlineImg.src = json.qr_code;
                    if (inlineLink) inlineLink.href = json.qr_code;
                    if (inlineOpen) inlineOpen.href = json.qr_code;
                    showToast('QR regenerated', 'success');
                } else {
                    showToast(json.error || 'Failed to regenerate QR', 'error');
                }
            } catch (e) {
                showToast('Failed to regenerate QR', 'error');
            }
        };

        function showToast(message, type = 'info') {
            // Simple toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10050;
                background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: #fff; padding: 10px 14px; border-radius: 8px; box-shadow: 0 8px 20px rgba(0,0,0,.2);
                display: flex; align-items: center; gap: 8px; font-weight: 600;`;
            toast.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i><span>${message}</span>`;
            document.body.appendChild(toast);
            setTimeout(()=>{ toast.remove(); }, 3500);
        }
    });
    </script>
</head>
<body class="page-container">
    <nav class="navbar">
        <div class="container">
            <a href="/dashboard.html" class="nav-brand profile-brand">
                <div class="brand-logo-wrap"><img src="/images/images.png" class="brand-logo-img" alt="ECC"></div>
                <div class="brand-text">
                    <h1 style="margin:0;color:#fff;font-size:1.5rem;">ECC Smart Attendance</h1>
                    <span class="brand-subtitle">Add Employee</span>
                </div>
            </a>
            <div class="nav-menu">
                <a href="/dashboard.html" class="nav-link"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                <a href="/employees.html" class="nav-link"><i class="fas fa-users"></i><span>Employees</span></a>
                <a href="/scanner.html" class="nav-link"><i class="fas fa-qrcode"></i><span>Scanner</span></a>
                <a href="/reports.html" class="nav-link"><i class="fas fa-chart-bar"></i><span>Reports</span></a>
            </div>
        </div>
    </nav>

    <main class="page">
        <div class="card">
            <div class="header">
                <i class="fas fa-user-plus"></i>
                <h1>Add Employee</h1>
            </div>
            <form id="employeeAddForm">
                <div class="grid">
                    <div class="form-group full">
                        <label for="name">Full Name *</label>
                        <input id="name" name="name" type="text" placeholder="Jane Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input id="email" name="email" type="email" placeholder="jane@company.com" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Phone *</label>
                        <input id="phone" name="phone" type="tel" placeholder="+1234567890" required>
                    </div>
                    <div class="form-group">
                        <label for="position">Position</label>
                        <input id="position" name="position" type="text" placeholder="e.g. Software Engineer">
                    </div>
                    <div class="form-group">
                        <label for="department">Department</label>
                        <select id="department" name="department">
                            <option value="">Select Department</option>
                            <option value="IT">IT</option>
                            <option value="HR">HR</option>
                            <option value="Finance">Finance</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Sales">Sales</option>
                            <option value="Operations">Operations</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="note">After saving, a QR code will be shown and you can capture face images for training.</div>
                <div class="actions">
                    <a class="btn btn-outline" href="/employees.html"><i class="fas fa-arrow-left"></i> Cancel</a>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Employee</button>
                </div>
            </form>
            <!-- Inline QR Panel (shown after save) -->
            <div id="qrInlinePanel" class="qr-preview" style="display:none; margin-top:1rem;">
                <a id="qrInlineLink" href="#" target="_blank" rel="noopener">
                    <img id="qrInlineImg" src="" alt="Employee QR">
                </a>
                <div id="qrInlineMeta" style="margin-top:.5rem; color:#4b5563;"></div>
                <div style="margin-top:.75rem; display:flex; gap:.5rem; justify-content:center;">
                    <button class="btn btn-outline" onclick="_downloadQR('qrInlineImg')"><i class="fas fa-download"></i> Download QR</button>
                    <button class="btn btn-outline" onclick="_regenerateQR()"><i class="fas fa-sync"></i> Regenerate</button>
                    <a id="qrInlineOpenBtn" class="btn btn-outline" href="#" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> Open</a>
                </div>
            </div>
        </div>
    </main>

    <!-- QR + Face Scan Modal -->
    <div id="qrFaceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Employee Registered</h3>
                <button class="modal-close" onclick="_closeModal()">×</button>
            </div>
            <div class="qr-preview">
                <a id="qrLink" href="#" target="_blank" rel="noopener">
                    <img id="qrImage" src="" alt="Employee QR">
                </a>
                <div id="qrMeta" style="margin-top:.5rem; color:#4b5563;"></div>
                <div style="margin-top:.75rem; display:flex; gap:.5rem; justify-content:center;">
                    <button class="btn btn-outline" onclick="_downloadQR()"><i class="fas fa-download"></i> Download QR</button>
                    <button class="btn btn-outline" onclick="_regenerateQR()"><i class="fas fa-sync"></i> Regenerate</button>
                    <a id="qrOpenBtn" class="btn btn-outline" href="#" target="_blank" rel="noopener"><i class="fas fa-external-link-alt"></i> Open</a>
                </div>
            </div>
            <div class="face-section">
                <h4 style="margin:0 0 .75rem 0;">Face Scan (optional)</h4>
                <div class="face-grid">
                    <div class="video-box">
                        <video id="camera" autoplay playsinline style="width:100%; border-radius:.5rem; background:#000;"></video>
                        <div style="display:flex; gap:.5rem; margin-top:.5rem;">
                            <button id="startBtn" class="btn btn-outline" onclick="_startCamera()"><i class="fas fa-video"></i> Start Camera</button>
                            <button id="captureBtn" class="btn btn-outline" onclick="_captureFrame()" disabled><i class="fas fa-camera"></i> Capture</button>
                        </div>
                    </div>
                    <div class="captures-box">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem;">
                            <span>Captures (<span id="capCount">3</span> required)</span>
                        </div>
                        <div id="captures" class="captures-list"></div>
                        <div style="margin-top:.75rem; display:flex; justify-content:flex-end;">
                            <button id="saveFacesBtn" class="btn btn-primary" onclick="_saveFaces()" disabled><i class="fas fa-save"></i> Save & Finish</button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:1rem;">
                <button class="btn btn-outline" onclick="_closeModal()"><i class="fas fa-times"></i> Close</button>
                <a class="btn btn-primary" href="/employees.html"><i class="fas fa-list"></i> Go to Employees</a>
            </div>
        </div>
    </div>
</body>
</html>

